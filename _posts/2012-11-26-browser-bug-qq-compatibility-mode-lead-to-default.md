---
layout: post
title: 坑爹的QQ浏览器默认兼容模式引出的网页隐患
category: "bug"
tags: ["browser"]
---

今天一大早就收到汽车网总编的报障，说我们汽车网大首页在QQ浏览器下刷新会卡住。该报障在到我这里之前还途经我们部门总监，刻不容缓马上开始查找引起该问题的原因。

跟据报障人的报料情况，是说一位北京从事网站编辑行业的网友用的是QQ浏览器6.14版本（目前最新版），因工作原因要访问我们太平洋网络的汽车网，经常刷新太平洋汽车网大首页会导致浏览器卡住，而访问汽车之家是没有问题的。这里有几个关键词：北京、QQ浏览器6.14版本、太平洋汽车网首页、汽车之家首页。笔者马上自己安装了相应版本的QQ浏览器进行测试，访问了太平洋汽车网首页与汽车之家首页并刷新了N次，浏览器均表示无卡住现象。但一个人测试的样本是不够的，我又安排了广州与北京的同事进行测试，均反馈说QQ浏览器表示无压力。

到这里查找问题原因行动陷入僵局，难道是个别电脑的特别问题吗？这时安排其他同事测试并反馈花了我一些时间，我回到自己的电脑前看到QQ浏览器打开很久了的太平洋汽车网首页，我又刷新了一次，没想到这次出问题了，页面卡了比较长的一段时间，起码有20秒以上才恢复正常。终于发现你了，原来是要打开页面一段时间后才会出现这们问题。马上让其他同事试试看，经过测试，其他同事也反馈放置一段时间后也会有同样的问题。同时我还发现，QQ浏览器是默认用兼容模式打开太平洋汽车网，而打开汽车之家默认的却是极速模式。于是我又测试了一下，手动改变QQ浏览器为极速模式访问太平洋汽车网，在该模式下并不会出现是述问题。根据搜索发现，QQ浏览器6.14版本是双核的，在兼容模式用ie内核，在极速模式下用webkit内核，而要开一个页面默认下是其浏览器智能判断。

问题找到的，同组内同事讨论了一下，页面打开放置一时间导致浏览器卡住一般是由于页面js或者flash有内存泄露引起的。而在旧版的ie才会有比较严重的内存泄露问题，新版的浏览器如firefox和chrome里很少这个问题。然后兵分两路，一路马上安排同事先检查看是该页面的js引起的还是flash引起的，检查方法很笨，就是先后去掉页面所有flash或者js，看是js还是flash导致问题的；另一路我去找目前在腾讯工作的前同事问问QQ浏览器的情况，为什么QQ浏览器打开太平洋网络网站的页面会默认用兼容模式，而打开汽车之家的是极速模式，这不是欺负人吗？在询问之前我测试了是否代码原因造成的，我直接把汽车之家的代码放到我们网站，还测试了很多其他我们网站的页面，得出一个结论，只要是我们的域名下，不管是什么代码，在QQ浏览器里是都会默认用兼容模式打开。我估计QQ浏览器有一个名单机制，在名单里的网站默认是什么模式就用什么模式访问。

经过询问，具体的询问过程涉及到QQ浏览器的开发机密，为了以后能和这位前同事保持良好关系，就不在这里透露了。询问的结果就是目前这个QQ浏览器版本太平洋网络的网站是默认在兼容模式下打开的，希望在下个版本修正这个问题，这不坑爹吗？

询问等答复的时候我顺便测试了一下太平洋电脑网，发现它在QQ浏览器中同样存在汽车网的问题。这时同事的测试结果也出来了，是页面的js造成的问题。听说我测试电脑网也出现了同样的问题，他想到有一块内容是两网共用的，而且用到了js，即页面最底部的六网内容推荐滚动块。于是把这块内容的js去掉后测试，发现问题解决了，用QQ浏览器兼容模式打开页面一段时间刷新也不会卡住了。最后马上研究这块滚动js的写法，发现这块滚动功能是一位一年多前离职的同事用第三方的js实现的，用了“margin-left”去实现滚动，把其改为用绝对定位实现后解决。至此，解决该问题用了整整一个工作日的时间。

得出结论：页面某内容块位置的改变用margin-left去实现，每次都会有一次reflow，但reflow不会立即发生，而是在条件成熟，如用offsetWidth获取宽度时会触发，也就是说，页面放的时间越长，就会越卡。还发现在遨游的兼容模式下也有这个问题，那么，可能山寨的浏览器都有这个问题。网上有人指出“国产壳子浏览器，如果电脑装IE8 IE9，默认都用IE7兼容模式渲染的”，然后我们在IE9的IE7模式下发现有这问题，原生IE6没发现这个问题，那么这个问题的浏览器应该就是IE7了，非常隐蔽的问题。

最后，其实这个问题是不应该出现的。第一，如果QQ浏览器默认所有网站都用极速模式去访问，这个问题就不会出现了，不明白为什么它会单独太平洋网络的网站和兼容模式，而且经过沟通还不能改，非常坑爹；第二，我们自己做的插件，早就不使用“margin”去实现滚动了，而是用绝对定位去实现，出现这个问题的原因，是有同事用了第三方的js去实现滚动。所以别人的东西最好别用，要用我们就得用自己的，自己的东西自己最熟悉，出问题了也很快可以发现。

(完)










